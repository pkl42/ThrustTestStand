<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="UTF-8">
    <title>Motor Thrust Test Stand</title>
	<link rel="stylesheet" href="style.css">	

</head>

<body>

    <h1 id="page-title">Motor Thrust Test Stand</h1>
	<button id="themeToggle" onclick="toggleTheme()">
    ðŸŒ™ / â˜€
	</button>
	<h2></h2>

	<section id="live">
		<h2>Live</h2>

		<div class="three-col">
			<!-- Left column: motor sensors -->
			<div>
				<div class="field">
					<label>Throttle:</label>
					<input type="range" id="throttle" min="0" max="100" oninput="onThrottleChange(this.value)">
					<span id="throttleVal">0</span> %
				</div>
				<div class="field"><label>Thrust:</label> <span id="thrust">0</span> gf</div>
				<div class="field"><label>Torque:</label> <span id="torque">0</span> Ncm</div>
				<div class="field"><label>Torque Cell 1:</label> <span id="torqueCell1">0</span> gf</div>
				<div class="field"><label>Torque Cell 2:</label> <span id="torqueCell2">0</span> gf</div>
				<div class="field"><label>RPM:</label> <span id="rpm">0</span></div>
			</div>

			<!-- Middle column: electrical -->
			<div>
				<div class="field"><label>Voltage:</label> <span id="voltage">0</span> V</div>
				<div class="field"><label>Current:</label> <span id="current">0</span> A</div>
				<div class="field"><label>Power:</label> <span id="power">0</span> W</div>
				<div class="field"><label>Thrust Ratio:</label> <span id="thrust_ratio">0</span> g/W</div>
				<div class="field"><label>Temperature:</label> <span id="temperature">0</span> Â°C</div>
			</div>

			<!-- Right column: Safety Trip -->
			<div id="safetyColumn">
				<div class="safety-banner" id="safetyBanner">
					<strong>SAFETY TRIP ACTIVE!</strong>
				</div>
				<div class="field">
					<label>Trip Source:</label>
					<span id="safetyTripSource">â€”</span>
				</div>
				<div class="field">
					<label>Trip Reason:</label>
					<span id="safetyTripReason">â€”</span>
				</div>
				<div class="field">
					<label>Trip Value:</label>
					<span id="safetyTripValue">0</span>
				</div>
				<div class="field button-group">
					<button onclick="clearSafetyTrip()">Clear Safety Trip</button>
				</div>
				<div class="field button-group"><button onclick="tare(event)">Tare Sensors</button></div>
			</div>
		</div>
	</section>


	
	<section id="test">
		<h2>Test</h2>

		<div class="three-col">
			<!-- Left column -->
			<div>
				<div class="field">
					<label>Status:</label>
					<span id="test_status">Idle</span>
				</div>

				<div class="field">
					<label>Teststep:</label>
					<span id="test_step">0</span> /
					<span id="test_steps_total">0</span>
				</div>

				<div class="field progress-container">
					<label>Progress:</label>
					<progress id="testProgress" value="0" max="100"></progress>
					<span id="testProgressText">0 %</span>
				</div>

				<div class="field">
					<label>Duration Estim.:</label>
					<span id="estDurationS">0</span> s
				</div>
				
				<div class="field">
					<label>Duration Actual:</label>
					<span id="actDurationS">0</span> s
				</div>
				
				<div class="field">
					<label>Sample Count:</label>
					<span id="thrust_samples">0</span>
				</div>

			</div>

			<!-- Middle column -->
			<div>
				<div class="field">
					<label for="motor_type">Motor Type:</label>
					<input type="text" id="motor_type" placeholder="e.g. T-Motor F60 Pro">
				</div>
				
				<div class="field">
					<label for="esc_type">ESC Type:</label>
					<input type="text" id="esc_type" placeholder="e.g. FLYCOLOR 45A">
				</div>

				<div class="field">
					<label for="prop_type">Propeller Type:</label>
					<input type="text" id="prop_type" placeholder="e.g. 5x4.3x3">
				</div>
				
				<div class="field">
					<label for="csv_format">CSV Format:</label>
					<select id="csv_format">
						<option value=".,">Standard (.,) â€“ US / ISO</option>
						<option value=",;">Excel DE (,;) â€“ German</option>
						<option value=".;">Semicolon (.;) â€“ dot decimal</option>
					</select>
				</div>

				<div class="field">
					<label for="protocol_select">Test Protocol:</label>
					<select id="protocol_select">
						<option value="">-- no protocol selected --</option>
					</select>
				</div>

				<div class="field">
					<label>Protocol Info:</label>
					<div id="protocol_info" class="small-text">none</div>
				</div>

			</div>
			<!-- Right column -->
			<div>
				<div class="field button-group">
					<button onclick="startTest()">Start Test</button>
				</div>
				<div class="field button-group">
					<button onclick="stopTest()">Stop Test</button>
				</div>
				<div class="field button-group">
					<button onclick="downloadMeanCSV()">Download Mean CSV</button>
				</div>

				<div class="field button-group">
					<button onclick="downloadStatsCSV()">Download Statistics CSV</button>
				</div>
				
			</div>
		</div>
	</section>

	
	<section id="system">
		<h2>System State</h2>

		<div class="three-col">
			<!-- LEFT -->
			<div>
				<div class="state-grid">
					<div>Thrust Sensor</div><span id="state-thrust" class="state">â€”</span>
					<div>Torque Sensor</div><span id="state-torque" class="state">â€”</span>
					<div>Thermocouple</div><span id="state-thermo" class="state">â€”</span>
					<div>RPM Sensor</div><span id="state-rpm" class="state">â€”</span>
					<div>Current Sensor</div><span id="state-current" class="state">â€”</span>
					<div>Voltage Sensor</div><span id="state-voltage" class="state">â€”</span>
				</div>
			</div>

			<!-- Middle column -->
			<div>
				<div class="state-grid">

					<div>Motor</div><span id="state-motor" class="state">â€”</span>

					<div>Motor Mount</div><span id="state-motor-mount" class="state">â€”</span>
					<hr>
				</div>

				<div  class="field button-group">
					<button id="armMotorBtn" onclick="toggleMotor(latestMotorMount)">Arm Motor</button>
				</div>
				
				<div class="setup-row-3">
					<label for="manual_idle_disarm_timeout_s">Auto Disarm on Idle (s):</label>
					<input type="number" 
						id="manual_idle_disarm_timeout_s" 
						step="1"
						max="3600"
						 min="5">
					<button
					  data-api="/api/calibration"
					  data-params="manual_idle_disarm_timeout_s"
					  data-action="post+refresh"
					  data-loader="loadCalibration"
					  onclick="handleAction(this)">
					  Set
					</button>
				
				</div>


			</div>
			<!-- Right column -->
			<div>
				<div  class="field button-group">
					<button id="initializeBtn" onclick="initializeSystem()">Initialize System</button>
				</div>
			</div>			
		</div>
	</section>
	
	
	<section id="safety">
		<h2>Safety Limits</h2>
		<p class="hint">
			Limits are enforced during operation and may trigger a safety shutdown if exceeded.
		</p>

		<div class="three-col">
			<!-- LEFT -->
			<div>

				<div class="setup-row-3">
					<label for="limits.throttle_percent">Throttle Limit (%):</label>
					<input type="number" id="limits.throttle_percent" step="1">
					<button
					  data-api="/api/safety"
					  data-params="limits.throttle_percent"
					  data-action="post+refresh"
					  data-loader="loadSafetySettings"
					  onclick="handleAction(this)">
					  Set
					</button>
					<hr>
				</div>

				<div class="setup-row-3">
					<label for="limits.current_a">Current Limit (A):</label>
					<input type="number" id="limits.current_a" step="0.1">
					<button
					  data-api="/api/safety"
					  data-params="limits.current_a"
					  data-action="post+refresh"
					  data-loader="loadSafetySettings"
					  onclick="handleAction(this)">
					  Set
					</button>
					<hr>
				</div>

			</div>

			<!-- Middle column -->
			<div>

				<div class="setup-row-3">
					<label for="limits.voltage_max_v">Voltage Limit max. (V):</label>
					<input type="number" id="limits.voltage_max_v" step="0.1">
					<button
					  data-api="/api/safety"
					  data-params="limits.voltage_max_v"
					  data-action="post+refresh"
					  data-loader="loadSafetySettings"
					  onclick="handleAction(this)">
					  Set
					</button>

					<hr>
				
				</div>

				
				<div class="setup-row-3">
					<label for="limits.voltage_min_v">Voltage Limit min. (V):</label>
					<input type="number" id="limits.voltage_min_v" step="0.1">
					<button
					  data-api="/api/safety"
					  data-params="limits.voltage_min_v"
					  data-action="post+refresh"
					  data-loader="loadSafetySettings"
					  onclick="handleAction(this)">
					  Set
					</button>
					<hr>
				</div>				

				<div class="setup-row-3">
					<label for="limits.thrust_gf">Thrust Limit (gf):</label>
					<input type="number" id="limits.thrust_gf" step="10">
					<button
					  data-api="/api/safety"
					  data-params="limits.thrust_gf"
					  data-action="post+refresh"
					  data-loader="loadSafetySettings"
					  onclick="handleAction(this)">
					  Set
					</button>
				</div>
			</div>
			<!-- Right column -->
			<div>
			</div>
		</div>
	</section>


	<section id="calibration">
		<h2>Calibration</h2>

			
		<div class="three-col">
			<!-- LEFT -->
			<div>
			
				<div class="setup-row-3">
					<label for="thrust.cal">Thrust Cal-Factor:</label>
					<input type="number" id="thrust.cal" step="0.01">
					<button
					  data-api="/api/calibration"
					  data-params="thrust.cal"
					  data-action="post"
					  data-loader="loadCalibration"
					  onclick="handleAction(this)">
					  Set
					</button>
					<hr>
				</div>

				<div class="setup-group">
					<div class="setup-title">Torque Calibration</div>

					<div class="setup-row">
						<label for="torque.cal1">Torque Cal-Factor 1:</label>
						<input type="number" id="torque.cal1" step="0.01">
					</div>

					<div class="setup-row">
						<label for="torque.cal2">Torque Cal-Factor 2:</label>
						<input type="number" id="torque.cal2" step="0.01">
					</div>

					<div class="setup-row">
						<label for="torque.distance_mm">Loadcell Distance (mm):</label>
						<input type="number" id="torque.distance_mm" step="1">
					</div>

					<div class="setup-row">
						<span></span>
						<button
						  data-api="/api/calibration"
						  data-params="torque.distance_mm"
						  data-action="post"
						  data-loader="loadCalibration"
						  onclick="handleAction(this)">
						  Set Torque Calibration
						</button>
					</div>
				</div>

			</div>
			<!-- Middle column -->
			<div>
				<div class="setup-row-3">

					<label for="current.sensitivity">Current Sensitivity (voltsPerAmp):</label>
					<input type="number" id="current.sensitivity" step="0.001">
					<button
					  data-api="/api/calibration"
					  data-params="current.sensitivity"
					  data-action="post"
					  data-loader="loadCalibration"
					  onclick="handleAction(this)">
					  Set
					</button>

				</div>
			
				<div class="setup-row-3">
					<label for="actual_current">Actual Current (A):</label>
					<input type="number" id="actual_current" step="0.01" placeholder="Enter known current from PSU">
					<button
					  data-api="/api/calibration/calibrate_current"
					  data-params="actual_current"
					  data-action="post"
					  data-loader="loadCalibration"
					  onclick="handleAction(this)">
					  Set
					</button>
					<hr>
				</div>

				<div class="setup-row-3">

				<label for="voltage.calibration">Voltage Calibration:</label>
				<input type="number" id="voltage.calibration" step="0.01">
				<button
					  data-api="/api/calibration"
					  data-params="voltage.calibration"
					  data-action="post"
					  data-loader="loadCalibration"
					  onclick="handleAction(this)">
					  Set
					</button>
				<hr>
				</div>


			</div>
			<!-- Right column -->
			<div>
				<div class="setup-group">
					<div class="setup-title">ESC PWM Range</div>

					<div class="setup-row">
						<label for="motor_pwm.min_us">Min Pulse (Âµs):</label>
						<input type="number" id="motor_pwm.min_us" step="1">
					</div>

					<div class="setup-row">
						<label for="motor_pwm.max_us">Max Pulse (Âµs):</label>
						<input type="number" id="motor_pwm.max_us" step="1">
					</div>

					<div class="setup-row">
						<span></span>
						<button
						  data-api="/api/calibration"
						  data-params="motor_pwm.max_us,motor_pwm.min_us"
						  data-action="post"
						  data-loader="loadCalibration"
						  onclick="handleAction(this)">
						  Set ESC PWM Range
						</button>
					</div>
					
				</div>

			</div>
		</div>

	</section>
	
	<section id="protocol-repository">
	  <h2>Protocol Repository</h2>

	  <div class="three-col">

		<!-- Left column: protocol list + actions -->
		<div>

		  <div class="field">
			<label>Available Protocols</label>
		  </div>

		  <div id="protocol_list" class="protocol-list">
			<!-- dynamically filled -->
			<!--
			<div class="protocol-entry selected" data-id="static_sweep">
			  <div class="protocol-name">Static Thrust Sweep</div>
			  <div class="protocol-meta">12 steps Â· ~90 s</div>
			</div>
			-->
		  </div>

		  <div class="field button-group">
			<input type="file"
				   id="protocol_file_repo"
				   accept=".json"
				   onchange="uploadProtocolToRepo()">
		  </div>

		  <div class="field button-group">
			<button onclick="deleteSelectedProtocolRepo()">
			  Delete Selected Protocol
			</button>
		  </div>

		</div>

		<!-- Middle column: metadata -->
		<div>

		  <div class="field">
			<label>Protocol JSON</label>
		  </div>

		  <pre id="protocol_json" class="code-view">
	Select a protocol to view its JSON
		  </pre>

		</div>

		<!-- Right column: read-only JSON -->
		<div>



		</div>

	  </div>
	</section>

<script src="main.js"></script>	

</body>

</html>